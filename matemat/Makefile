# vim: set ft=make :

include ../Makefile.inc

.DEFAULT_GOAL := all

#  phony {{{1

.PHONY: debug

.PHONY: html

.PHONY: sync-html

.PHONY: $(ALL_SUBDIRS)
.PHONY: all install

.PHONY: $(CLEAN_SUBDIRS) $(CLEAN_HTML_SUBDIRS) $(WIPE_SUBDIRS)

.PHONY: clean clean-html wipe

# debug {{{1

debug:
	@echo $(SUBDIRS)
	@echo $(ORG_PDF_FILES)

# org -> html {{{1

%.html: %.org $(INC_FILES) $(INC_MATHJAX_FILES)
	$(EMACS) $(EMACS_PRE_FLAGS) $< $(EMACS_POST_FLAGS)
	remove-max-width-from-org-html-export.zsh $(patsubst %.org,%.html,$<)
	@$(ECHO)

html: $(ORG_HTML_FILES)

# org -> tex {{{1

%.tex: %.org $(INC_FILES) $(INC_LATEX_FILES)
	$(EMACS) $(EMACS_PRE_FLAGS) $< $(EMACS_POST_FLAGS_TEX)
	@$(ECHO)

tex: $(ORG_TEX_FILES)

# tex --> pdf {{{1

%.pdf: pdf/%.pdf
	ln -s pdf/$@ $@

pdf/%.pdf: %.tex | pdf_dir
	latexmk -f -pdf -shell-escape -output-directory=pdf $<
	#mv $@ pdf/
	#mv $**.aux pdf/

pdf_dir:
	mkdir -p pdf

pdf_files: $(ORG_PDF_FILES)

# sync -> html dir {{{1

sync-html: html $(ALL_SUBDIRS)
	$(RSYNC) $(CUR_DIR)/ $(HTML_DIR)
	@$(ECHO)

# all, install {{{1

$(ALL_SUBDIRS):
	$(MAKELINE) -C ${@:all-%=%} all
	@$(ECHO)

all: html $(ALL_SUBDIRS) clean

install: all sync-html

# clean, wipe {{{1

$(CLEAN_SUBDIRS):
	$(MAKELINE) -C ${@:clean-%=%} clean
	@$(ECHO)

$(CLEAN_HTML_SUBDIRS):
	$(MAKELINE) -C ${@:clean-html-%=%} clean-html
	@$(ECHO)

$(WIPE_SUBDIRS):
	$(MAKELINE) -C ${@:wipe-%=%} wipe
	@$(ECHO)

clean: $(CLEAN_SUBDIRS)
	rm -f ?*~
	rm -f ?*.aux
	rm -f ?*.fls
	rm -f ?*.fdb
	rm -f ?*.fdb_latexmk
	rm -f ?*.log
	rm -f ?*.out
	rm -f ?*.toc
	rm -f ?*.ptc
	remove-obsolete-targets.zsh +org -html
	# only here because it is generated by emacs org export
	#rm -f ?*.tex

clean-html: $(CLEAN_HTML_SUBDIRS)
	rm -f ?*.html
	rm -f ?*~

wipe: $(WIPE_SUBDIRS)
	rm -f ?*.html
	rm -f ?*~
